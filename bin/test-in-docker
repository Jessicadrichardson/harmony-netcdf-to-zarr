#!/bin/bash

set -e

# This script mounts the contents of the current directory, and optionally the Python library in a peer
# directory into the Harmony docker image and runs the test suite.  It is meant to allow development and
# testing without repeatedly rebuilding the docker image.  To run a completely clean container using only
#  what is in the image, as will be done in CI environments, run
# `docker run --rm -it --env-file=.env harmony/netcdf-to-zarr-tests`

find . | grep -E "(__pycache__|\.pyc|\.pyo$)" | xargs rm -rf

args="-v $(pwd):/home"

if [ -d ../harmony-service-lib-py ]; then
  (cd ../harmony-service-lib-py && make clean)
  args="$args -v $(pwd)/../harmony-service-lib-py/harmony:/usr/lib/harmony-service-lib-py/harmony"
  args="$args -e PYTHONPATH=/usr/lib/harmony-service-lib-py"
fi

docker run --rm -it $args harmony/netcdf-to-zarr-tests "$@"

