#!/bin/bash

set -e

image="harmony/netcdf-to-zarr"
tag=${1:-latest}

# source the .env file if it exists
[[ -f .env ]] && source .env

# NOTE: We use the `host` network mode so we can have access to the
# host VPN connection used for Nexus access.

if [ -n "$DIND" ]; then
  docker -H $DOCKER_DAEMON_ADDR build --network host -t ${image}:${tag} .
else
  docker build --network host -t ${image}:${tag} .
fi

if [[ ! -z "${LOCAL_SVCLIB_DIR}" ]]
then
  LOCAL_SVCLIB=deps/harmony-service-lib
  mkdir -p "${LOCAL_SVCLIB}"
  pushd "${LOCAL_SVCLIB_DIR}"
  make build
  popd
  mv "${LOCAL_SVCLIB_DIR}"/dist/* "${LOCAL_SVCLIB}"
  if [ -n "$DIND" ]; then
    docker -H $DOCKER_DAEMON_ADDR build -f Dockerfile.local-service-lib \
      --build-arg LOCAL_SVCLIB=${LOCAL_SVCLIB} \
      --network host \
      -t ${image}:${tag} .
  else
    docker build -f Dockerfile.local-service-lib \
      --build-arg LOCAL_SVCLIB=${LOCAL_SVCLIB} \
      --network host \
      -t ${image}:${tag} .
  fi
  rm -r ${LOCAL_SVCLIB}
fi
